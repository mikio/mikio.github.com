<?xml version="1.0" encoding="shift_jis"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
lang="ja" xml:lang="ja">
<head>
<title>tetris</title>
<meta http-equiv="Content-Type" content="text/html;charset=shift_jis"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2011-11-18 19:39:48 "/>
<meta name="author" content=""/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="org.css">
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>
<div id="content">

<h1 class="title">tetris</h1>



<pre class="src src-clojure">(<span class="org-builtin">ns</span> tetris
  (<span class="org-constant">:import</span>
    (javax.swing <span class="org-preprocessor">JFrame</span>)
    (java.awt <span class="org-preprocessor">Canvas</span> <span class="org-preprocessor">Font</span> <span class="org-preprocessor">Graphics</span> <span class="org-preprocessor">Color</span> <span class="org-preprocessor">Toolkit</span>)   
    (java.awt.event <span class="org-preprocessor">ActionListener</span> <span class="org-preprocessor">KeyListener</span> <span class="org-preprocessor">KeyEvent</span>))
  (<span class="org-constant">:gen-class</span>))
 
(<span class="org-keyword">def</span> <span class="org-function-name">*cols*</span> 10)
(<span class="org-keyword">def</span> <span class="org-function-name">*rows*</span> 20)
(<span class="org-keyword">def</span> <span class="org-function-name">*width*</span> 300)
(<span class="org-keyword">def</span> <span class="org-function-name">*height*</span> 600)
(<span class="org-keyword">def</span> <span class="org-function-name">*offset*</span> (<span class="org-variable-name">atom</span> [0, 0]))
(<span class="org-keyword">def</span> <span class="org-function-name">*rotation*</span> (<span class="org-variable-name">atom</span> nil))
(<span class="org-keyword">def</span> <span class="org-function-name">*colors*</span> [<span class="org-preprocessor">Color/red</span>, <span class="org-preprocessor">Color/blue</span>, <span class="org-preprocessor">Color/green</span>, <span class="org-preprocessor">Color/yellow</span>,
               <span class="org-preprocessor">Color/yellow</span>, <span class="org-preprocessor">Color/orange</span>, <span class="org-preprocessor">Color/magenta</span>])
(<span class="org-keyword">def</span> <span class="org-function-name">*shapes*</span>  [[[0,1],[0,2],[0,3],[0,4]]
                [[0,0],[0,1],[1,1],[1,2]]
                [[1,2],[1,1],[0,1],[0,0]]
                [[0,1],[1,1],[1,0],[2,1]]
                [[0,0],[0,1],[1,0],[1,1]]
                [[0,0],[0,1],[0,2],[1,2]]
                [[1,0],[1,1],[1,2],[0,2]]])

(<span class="org-keyword">defn</span> <span class="org-function-name">get-block</span> []
  (<span class="org-builtin">let</span> [shape (rand-nth *shapes*)
        offset (<span class="org-variable-name">inc</span> (<span class="org-variable-name">rand-int</span> (<span class="org-variable-name">-</span> *cols* 3)))]
    {<span class="org-constant">:color</span> (<span class="org-variable-name">get</span> *colors* (<span class="org-variable-name">rand-int</span> (<span class="org-variable-name">count</span> *colors*)))
     <span class="org-constant">:shape</span> (<span class="org-variable-name">map</span> (<span class="org-variable-name">fn</span> [[x y]] [(<span class="org-variable-name">+</span> x offset), y]) shape)}))

(<span class="org-keyword">defn</span> <span class="org-function-name">get-board</span> []
  (<span class="org-variable-name">vec</span> (<span class="org-variable-name">map</span> (<span class="org-variable-name">fn</span> [_] <span class="org-preprocessor">Color/black</span>) (<span class="org-variable-name">range</span> (<span class="org-variable-name">*</span> *rows* *cols*)))))
 
(<span class="org-keyword">defn</span> <span class="org-function-name">pos-to-xy</span> [pos]
  (<span class="org-builtin">let</span> [x (<span class="org-variable-name">mod</span> pos *cols*)
        y (<span class="org-variable-name">int</span> (<span class="org-variable-name">/</span> (<span class="org-variable-name">-</span> pos x) *cols*))]
    [x, y]))
 
(<span class="org-keyword">defn</span> <span class="org-function-name">collides?</span>
  ([board x y pos]
    (<span class="org-builtin">let</span> [[posx posy] (pos-to-xy pos)]    
      (<span class="org-builtin">and</span>
        (<span class="org-variable-name">&gt;</span> x (<span class="org-variable-name">-</span> 1))
        (<span class="org-variable-name">&lt;</span> x *cols*)
        (<span class="org-variable-name">&lt;</span> y *rows*)
        (<span class="org-variable-name">not</span> (<span class="org-builtin">and</span>
               (<span class="org-variable-name">=</span> posx x)
               (<span class="org-variable-name">=</span> posy y)                       
               (<span class="org-variable-name">not=</span> <span class="org-preprocessor">Color/black</span> (<span class="org-variable-name">get</span> board (<span class="org-variable-name">+</span> pos *cols*))))))))
  ([board shape pos]
    (<span class="org-variable-name">every?</span>
      #{true}
      (<span class="org-builtin">for</span> [[x y] shape]
        (collides? board x y pos))))
  ([board shape]
    (<span class="org-variable-name">not</span> (<span class="org-variable-name">reduce</span>
           #(<span class="org-builtin">and</span> %1 (collides? board shape %2))
           (<span class="org-variable-name">range</span> (<span class="org-variable-name">count</span> board)))) ))

(<span class="org-keyword">defn</span> <span class="org-function-name">rotate</span> [board shape]
  (<span class="org-builtin">if</span> (<span class="org-variable-name">nil?</span> @*rotation*)
    shape
    (<span class="org-builtin">let</span> [[avg-x avg-y] (<span class="org-builtin">-&gt;&gt;</span> shape
                          (<span class="org-variable-name">reduce</span>
                            (<span class="org-variable-name">fn</span> [[tx ty] [x y]]
                              [(<span class="org-variable-name">+</span> tx x), (<span class="org-variable-name">+</span> ty y)]))
                          (<span class="org-variable-name">map</span> #(<span class="org-variable-name">int</span> (<span class="org-variable-name">/</span> % 4))))
          
          rotated (<span class="org-variable-name">map</span> (<span class="org-variable-name">fn</span> [[x y]]
                         [(<span class="org-variable-name">int</span> (<span class="org-variable-name">+</span> avg-x (<span class="org-variable-name">-</span> y avg-y)))
                          (<span class="org-variable-name">int</span> (<span class="org-variable-name">-</span> avg-y (<span class="org-variable-name">-</span> x avg-x)))])
                    shape)]     
      (<span class="org-builtin">if</span> (collides? board rotated)
        shape rotated))))

(<span class="org-keyword">defn</span> <span class="org-function-name">shift</span> [board shape]
  (<span class="org-builtin">let</span> [shifted (<span class="org-variable-name">map</span>
                  (<span class="org-variable-name">fn</span> [[x y]]
                    [(<span class="org-variable-name">+</span> x (<span class="org-variable-name">first</span> @*offset*)), y])
                  shape)]
    (<span class="org-builtin">if</span> (collides? board shifted)
      shape shifted)))

(<span class="org-keyword">defn</span> <span class="org-function-name">transform</span> [board block drop?]

  (<span class="org-builtin">let</span> [rotated (<span class="org-builtin">-&gt;&gt;</span> (<span class="org-constant">:shape</span> block)
                     (shift board)  
                     (rotate board))]
    {<span class="org-constant">:color</span> (<span class="org-constant">:color</span> block)
     <span class="org-constant">:shape</span> (<span class="org-builtin">if</span> drop?
              (<span class="org-variable-name">map</span> (<span class="org-variable-name">fn</span> [[x y]]
                     [x, (<span class="org-builtin">if</span> drop? (<span class="org-variable-name">inc</span> y) y)])
                   rotated)
              rotated)}))

(<span class="org-keyword">defn</span> <span class="org-function-name">clear-lines</span> [board]
  (<span class="org-builtin">let</span> [new-board (<span class="org-builtin">-&gt;&gt;</span> board
                    (<span class="org-variable-name">partition</span> *cols*)
                    (<span class="org-variable-name">filter</span> #(<span class="org-variable-name">some</span> #{<span class="org-preprocessor">Color/black</span>} %))
                    (<span class="org-variable-name">apply</span> concat))         
        num-removed (<span class="org-variable-name">-</span> (<span class="org-variable-name">count</span> board) (<span class="org-variable-name">count</span> new-board))]   
    [num-removed
     (<span class="org-variable-name">into</span> 
       (<span class="org-variable-name">vec</span> (<span class="org-variable-name">map</span> (<span class="org-variable-name">fn</span> [_] <span class="org-preprocessor">Color/black</span>)
              (<span class="org-variable-name">range</span> num-removed)))
       new-board)]))

(<span class="org-keyword">defn</span> <span class="org-function-name">update-board</span> [board block]
  (<span class="org-builtin">let</span> [shape (<span class="org-constant">:shape</span> block)]
    (<span class="org-variable-name">vec</span> (<span class="org-variable-name">map</span> #(<span class="org-builtin">let</span> [[x y] (pos-to-xy %)]
                 (<span class="org-builtin">if</span> (<span class="org-variable-name">some</span>
                       (<span class="org-variable-name">fn</span> [[px py]] (<span class="org-builtin">and</span>(<span class="org-variable-name">=</span> x px) (<span class="org-variable-name">=</span> y py)))
                       shape)
                   (<span class="org-constant">:color</span> block) (<span class="org-variable-name">get</span> board %)))
           (<span class="org-variable-name">range</span> (<span class="org-variable-name">count</span> board))))))

(<span class="org-keyword">defn</span> <span class="org-function-name">game-over?</span> [board]
  (<span class="org-variable-name">not</span> (<span class="org-variable-name">reduce</span>  #(<span class="org-builtin">and</span> %1 (<span class="org-variable-name">=</span> <span class="org-preprocessor">Color/black</span> %2))
         (<span class="org-variable-name">butlast</span> (<span class="org-variable-name">rest</span> (<span class="org-variable-name">take</span> *cols* board))))))

<span class="org-comment-delimiter">;;;;;;</span><span class="org-comment">Controls;;;;
</span>(<span class="org-keyword">def</span> <span class="org-function-name">*dirs*</span> {<span class="org-preprocessor">KeyEvent/VK_LEFT</span>  [-1, 0]
             <span class="org-preprocessor">KeyEvent/VK_RIGHT</span> [1, 0]
             <span class="org-preprocessor">KeyEvent/VK_UP</span> <span class="org-constant">:left</span>
             <span class="org-preprocessor">KeyEvent/VK_DOWN</span> <span class="org-constant">:right</span>})

(<span class="org-keyword">defn</span> <span class="org-function-name">handle-input</span> [<span class="org-type">#^KeyEvent</span> event]
  (<span class="org-builtin">let</span> [key (<span class="org-preprocessor">.getKeyCode</span> event)]
    (<span class="org-builtin">cond</span>
      (<span class="org-builtin">or</span> (<span class="org-variable-name">=</span> key <span class="org-preprocessor">KeyEvent/VK_LEFT</span>) (<span class="org-variable-name">=</span> key <span class="org-preprocessor">KeyEvent/VK_RIGHT</span>))
      (<span class="org-builtin">let</span> [disp (*dirs* key)]
        (<span class="org-builtin">when</span> disp (<span class="org-variable-name">swap!</span> *offset* #(<span class="org-variable-name">map</span> + disp %))))
      (<span class="org-builtin">or</span> (<span class="org-variable-name">=</span> key <span class="org-preprocessor">KeyEvent/VK_UP</span>) (<span class="org-variable-name">=</span> key <span class="org-preprocessor">KeyEvent/VK_DOWN</span>))
      (<span class="org-variable-name">reset!</span> *rotation* (*dirs* key)))))

(<span class="org-keyword">defn</span> <span class="org-function-name">input-listener</span> []
  (<span class="org-variable-name">proxy</span> [<span class="org-preprocessor">ActionListener</span> <span class="org-preprocessor">KeyListener</span>] []
    (<span class="org-preprocessor">actionPerformed</span> [e])
    (<span class="org-preprocessor">keyPressed</span> [e] (handle-input e))
    (<span class="org-preprocessor">keyReleased</span> [e])
    (<span class="org-preprocessor">keyTyped</span> [e])))

<span class="org-comment-delimiter">;;;;;;;</span><span class="org-comment">UI;;;;;;;;;
</span>(<span class="org-keyword">defn</span> <span class="org-function-name">draw</span> [<span class="org-type">#^Canvas</span> canvas draw-fn]
  (<span class="org-builtin">let</span> [buffer  (<span class="org-preprocessor">.getBufferStrategy</span> canvas)
        g       (<span class="org-preprocessor">.getDrawGraphics</span> buffer)]
    (<span class="org-builtin">try</span>
      (draw-fn g)
      
      (<span class="org-builtin">finally</span> (<span class="org-preprocessor">.dispose</span> g)))
    (<span class="org-builtin">if</span> (<span class="org-variable-name">not</span> (<span class="org-preprocessor">.contentsLost</span> buffer))
      (<span class="org-builtin">.</span> buffer show))
    (<span class="org-builtin">..</span> <span class="org-preprocessor">Toolkit</span> (<span class="org-preprocessor">getDefaultToolkit</span>) (<span class="org-variable-name">sync</span>))))

(<span class="org-keyword">defn</span> <span class="org-function-name">draw-square</span> [x y color <span class="org-type">#^Graphics</span> g]
  (<span class="org-builtin">let</span> [width  (<span class="org-variable-name">/</span> *width* *cols*)
        height (<span class="org-variable-name">/</span> *height* *rows*)
        xpos   (<span class="org-variable-name">*</span> x width)
        ypos   (<span class="org-variable-name">*</span> y width)]
    (<span class="org-builtin">doto</span> g
      (<span class="org-preprocessor">.setColor</span> color)
      (<span class="org-preprocessor">.fillRect</span> xpos, ypos, width, height)
      (<span class="org-preprocessor">.setColor</span> <span class="org-preprocessor">Color/black</span>)
      (<span class="org-preprocessor">.drawRect</span> xpos, ypos, width, height))))

(<span class="org-keyword">defn</span> <span class="org-function-name">draw-text</span> [<span class="org-type">#^Graphics</span> g color text x y]
  (<span class="org-builtin">doto</span> g
    (<span class="org-preprocessor">.setColor</span> color)
    (<span class="org-preprocessor">.drawString</span> text x y)))

(<span class="org-keyword">defn</span> <span class="org-function-name">draw-game-over</span> [score]
  (<span class="org-variable-name">fn</span> [<span class="org-type">#^Graphics</span> g] 
    (<span class="org-builtin">doto</span> g
      (<span class="org-preprocessor">.setColor</span> (new <span class="org-preprocessor">Color</span> (<span class="org-variable-name">float</span> 0) (<span class="org-variable-name">float</span> 0) (<span class="org-variable-name">float</span> 0) (<span class="org-variable-name">float</span> 0.7)))
      (<span class="org-preprocessor">.fillRect</span> 0 0 *width* *height*))
    (draw-text g <span class="org-preprocessor">Color/red</span> <span class="org-string">"GAME OVER"</span> (<span class="org-variable-name">-</span> (<span class="org-variable-name">/</span> *width* 2) 50) (<span class="org-variable-name">/</span> *height* 2))
    (draw-text g <span class="org-preprocessor">Color/red</span> (<span class="org-variable-name">str</span> <span class="org-string">"Final Score: "</span> score) (<span class="org-variable-name">-</span> (<span class="org-variable-name">/</span> *width* 2) 55) (<span class="org-variable-name">+</span> 15 (<span class="org-variable-name">/</span> *height* 2)))))

(<span class="org-keyword">defn</span> <span class="org-function-name">draw-board</span> [board block score]
  (<span class="org-variable-name">fn</span> [<span class="org-type">#^Graphics</span> g]
    (<span class="org-builtin">doto</span> g
      (<span class="org-preprocessor">.setColor</span> <span class="org-preprocessor">Color/BLACK</span>)
      (<span class="org-preprocessor">.fillRect</span> 0 0 *width* *height*))
    
    (<span class="org-builtin">doseq</span> [square (<span class="org-variable-name">range</span> (<span class="org-variable-name">count</span> board))]
      (<span class="org-builtin">let</span> [[x y] (pos-to-xy square)]
        (draw-square x y (<span class="org-variable-name">get</span> board square) g)))
    
    (<span class="org-builtin">doseq</span> [[x y] (<span class="org-constant">:shape</span> block)]
      (draw-square x y (<span class="org-constant">:color</span> block) g))
    
    (draw-text g <span class="org-preprocessor">Color/green</span> (<span class="org-variable-name">str</span> <span class="org-string">"score: "</span> score) 20 25)))

(<span class="org-keyword">defn</span> <span class="org-function-name">-main</span> [&amp; args]
  (<span class="org-builtin">let</span> [frame  (<span class="org-preprocessor">JFrame.</span> <span class="org-string">"Tetris"</span>)
        canvas (<span class="org-preprocessor">Canvas.</span>)]
    (<span class="org-builtin">doto</span> frame
      (<span class="org-preprocessor">.setSize</span> *width* (<span class="org-variable-name">+</span> (<span class="org-variable-name">/</span> *height* *rows*) *height*))
      (<span class="org-preprocessor">.setDefaultCloseOperation</span> <span class="org-preprocessor">JFrame/EXIT_ON_CLOSE</span>)
      (<span class="org-preprocessor">.setResizable</span> false)
      (<span class="org-preprocessor">.add</span> canvas)
      (<span class="org-preprocessor">.setVisible</span> true))
    
    (<span class="org-builtin">doto</span> canvas
      (<span class="org-preprocessor">.createBufferStrategy</span> 2)
      (<span class="org-preprocessor">.addKeyListener</span> (input-listener))
      (<span class="org-preprocessor">.setVisible</span> true)
      (<span class="org-preprocessor">.requestFocus</span>))
    
    <span class="org-comment-delimiter">;;</span><span class="org-comment">game loop
</span>    (<span class="org-builtin">loop</span> [score    0
           board    (get-board)
           block    (get-block)
           old-time (<span class="org-preprocessor">System/currentTimeMillis</span>)]
      
      (<span class="org-variable-name">reset!</span> *offset* [0,0])
      (<span class="org-variable-name">reset!</span> *rotation* nil)
      (<span class="org-preprocessor">Thread/sleep</span> 10)
      (draw canvas (draw-board board block score))      
      
      (<span class="org-builtin">let</span> [cur-time (<span class="org-preprocessor">System/currentTimeMillis</span>)
            new-time (<span class="org-variable-name">long</span> (<span class="org-builtin">if</span> (<span class="org-variable-name">&gt;</span> (<span class="org-variable-name">-</span> cur-time old-time) 250)
                             cur-time
                             old-time))
            drop?    (<span class="org-variable-name">&gt;</span> new-time old-time)
            [num-removed, new-board] (clear-lines board)]
        (<span class="org-builtin">cond</span>
          (game-over? board)
          (draw canvas (draw-game-over score))
          
          (collides? board (<span class="org-constant">:shape</span> block))
          (<span class="org-builtin">recur</span>
            score
            (update-board board block)
            (get-block)
            new-time)
          
          <span class="org-constant">:default</span>
          (<span class="org-builtin">recur</span>
            (<span class="org-variable-name">+</span> score (<span class="org-variable-name">*</span> num-removed num-removed))
            new-board
            (transform board block drop?)
            new-time)
          )))))

</pre>


<div id="postamble">
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>
</div>
</div>
</body>
</html>
